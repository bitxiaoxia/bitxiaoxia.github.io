<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>IDC迁云相关工作 | 学海拾遗</title>
<meta name="description" content="工作生活中偶有所得，随手记下。">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://bitxiaoxia.github.io/favicon.ico?v=1574665566416">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://bitxiaoxia.github.io/styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />



  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://bitxiaoxia.github.io">
        <img src="https://bitxiaoxia.github.io/images/avatar.png?v=1574665566416" class="site-logo">
        <h1 class="site-title">学海拾遗</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="https://bitxiaoxia.github.io" class="site-nav">
            首页
          </a>
        
      
        
          <a href="https://bitxiaoxia.github.io/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="https://bitxiaoxia.github.io/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="https://bitxiaoxia.github.io/post/about/" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      工作生活中偶有所得，随手记下。
    </div>
    <div class="site-footer">
      转载注明出处</p>
Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://bitxiaoxia.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">IDC迁云相关工作</h2>
            <div class="post-date">2019-09-12</div>
            
            <div class="post-content">
              <p>这篇文章是对我们服务上云的过程的总结。由于我们这边用的是腾讯云，如果读者选用的云服务商不是腾讯云的话，具体的工具可能不太一样，但是流程应该是相同的。</p>
<!-- more -->
<h2 id="概述">概述：</h2>
<p>之前公司服务器在物理机房，机器成本较高且运维比较费力。<br>
后来我们把我们的服务都迁移到了腾讯云，节约了很大一部分成本。并且云服务器的运维比实际机房的运维要轻松一些，不需要操心哪块硬盘坏了，哪台机器需要升级配置之类。<br>
唯一的缺点可能是只能相信云服务商的技术，所以这边建议尽量选用大的云服务商，国内的话例如阿里云，腾讯云。<br>
总之，服务上云这件事，我认为应该是一种趋势。<br>
废话少说，下面开始正文：</p>
<blockquote>
<p>ps: 以下说明为机房前往腾讯云的流程。</p>
</blockquote>
<h3 id="step1-整理机房的机器和服务">Step1 整理机房的机器和服务</h3>
<p>在上云之前，我们需要先拆借一下所有服务用到的资源。<br>
具体来说呢，就是你的机房有多少台机器，每台机器的配置是什么，是用来做什么的。做这项工作需要你对公司项目非常熟悉，保证各项服务都能统计到。<br>
例如：</p>
<table>
<thead>
<tr>
<th>CPU</th>
<th>内存</th>
<th>硬盘</th>
<th>数量</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>4核</td>
<td>8G</td>
<td>1T</td>
<td>2</td>
<td>web服务</td>
</tr>
<tr>
<td>8核</td>
<td>16G</td>
<td>1T</td>
<td>2</td>
<td>微服务</td>
</tr>
<tr>
<td>4核</td>
<td>32G</td>
<td>1T</td>
<td>3</td>
<td>Redis缓存</td>
</tr>
<tr>
<td>4核</td>
<td>16G</td>
<td>4T</td>
<td>3</td>
<td>MySQL数据库</td>
</tr>
</tbody>
</table>
<p>这只是一个简表，实际上的情况要比这个复杂一些，需要列出具体CPU型号/频率，每个数据库的实际数据量，每个服务器的带宽。并且在物理机房时，会出现一台机器同时担任多个角色的情况，在上云的过程中，我们需要重新整理下每台服务器实际提供的服务。</p>
<p>如上例，有两台机器通过Tomcat对外提供Web服务；有两台机器提供除Web服务意外的服务，如日志服务，审计服务等；有3台机器做Redis缓存；还有3台服务器提供MySQL服务。那么我们需要四个云主机，两个云Redis，两个云MySQL(腾讯云上对应CVM，CRS，CDB)。具体资源规格，一般选用相同或略高一些的规格，需要读者根据实际负载自行斟酌（此时做到心中有数，暂时不用实际购买）。</p>
<h3 id="step2-在腾讯云搭建测试环境">Step2 在腾讯云搭建测试环境。</h3>
<p>之前的服务器应该也会区分生产环境和测试环境。<br>
我们先购置一台CVM，一个CRS，一个CDB用于云上测试环境的搭建。测试环境和生产环境数据不互通，只有开发时才会用到。做这一步主要有三个目的：</p>
<ol>
<li>为了检验Step1中，统计到的各项服务是否有缺失</li>
<li>由于要迁移服务，所以会有挺多的配置需要改变，例如数据库IP，nginx转发配置，集群IP地址集等等，这一步可以找出那些参数是在哪里配置的，进行修改。</li>
<li>对整个项目迁移的难度大概做一个评估，初步排除一些小的问题。</li>
</ol>
<p>这一步需要各位读者自行操作。是整个上云工作中的重点，可以说，如果这一步可以成功实现，那么可以保证能够成功上云。</p>
<h3 id="step31-云上生产环境资源购买">Step3.1 云上生产环境资源购买</h3>
<p>根据Step1中统计的数据，购买相应的CVM，CRS和CDB实例。建议先购买一个月的。同时注意下云服务调整配置哪些需要重启，哪些可以直接调整。</p>
<h3 id="step32-云上生产环境服务搭建">Step3.2 云上生产环境服务搭建</h3>
<p>在Step2中，我们已经进行了测试环境的搭建，这一步我们需要购买生产环境实际的CVM资源，并搭建服务。</p>
<h3 id="step33-云上生产环境空载数据库测试">Step3.3 云上生产环境空载数据库测试</h3>
<p>在DNS处注册一个新的域名，用了校验生产环境的复刻是否成功。</p>
<h3 id="step4-数据迁移演练">Step4 数据迁移演练</h3>
<p>截止上一步，我们已经保证整个项目是可用的，接下来需要做的是把已有的数据导入到云上。我们先做一次迁移演练。设置一个虚拟切换服务时间点，我们要做的是，确保在这个时间点，云上的数据和机房的数据是一致的。<br>
<strong>关于数据迁移：</strong><br>
腾讯云提供了数据迁移工具。<br>
<a href="https://cloud.tencent.com/document/product/571/13706">数据迁移工具</a><br>
可以进行包括MySQL，Redis，PostgreSQL，MongoDB 的迁移。<br>
由于数据量以及数据访问频率的原因，我们这边MySQL使用的是线上迁移（<a href="https://cloud.tencent.com/document/product/571/13728">MySQL 数据在线导入</a>），Redis是停服后导出RDB文件再导入进行的迁移（<a href="https://cloud.tencent.com/document/product/571/13749">使用 redis-port 进行迁移</a>）。各位读者可根据自己的情况考虑是不停服迁移，还是停服迁移。</p>
<blockquote>
<p>ps: 如果读者遇到了MySQL只有内网环境的情况，可以搭建一个MySQLProxy，新建用户，并分配权限，实现外网访问MySQL的需求，注意密码的复杂度和端口，避免被扫到。</p>
</blockquote>
<h3 id="step5-实际服务迁移演练">Step5 实际服务迁移演练</h3>
<p>当我们完成第一次数据迁移后，我们可以通过修改本地host的形势，检验在Step4中设置的切换服务时间点数据是否一致。检验Step3中各项服务是否正常。</p>
<h3 id="step6-清理云上数据库并再次迁移">Step6 清理云上数据库并再次迁移</h3>
<p>在进行过以上步骤以后，实际上可能会遇到的坑，我们应该都已经排查完了，我们终于可以正式进行上云的服务了。只需要重复Step3和Step4即可了。<br>
最后一步是把DNS服务商那里，原有域名从机房IP指向云上的IP。</p>
<p>由于本人表达能力略有捉急加上有些信息比较敏感，文章写得步骤可能稍显简单，许多细节没有列出来，希望各位在看的时候能够多思考。祝大家能够成功上云。</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://bitxiaoxia.github.io/tag/fEeaCQ9plp" class="tag">
                    服务器
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">下一篇</div>
                <a href="https://bitxiaoxia.github.io/post/3VTpiUsb3">
                  <h3 class="post-title">
                    GrayLog REST API 使用
                  </h3>
                </a>
              </div>
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
