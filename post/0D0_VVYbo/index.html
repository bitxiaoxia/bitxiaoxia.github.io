<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>关于JAVA多线程执行的问题 | 学海拾遗</title>
<meta name="description" content="工作生活中偶有所得，随手记下。">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://bitxiaoxia.github.io/favicon.ico?v=1574665566416">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://bitxiaoxia.github.io/styles/main.css">



<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />



  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://bitxiaoxia.github.io">
        <img src="https://bitxiaoxia.github.io/images/avatar.png?v=1574665566416" class="site-logo">
        <h1 class="site-title">学海拾遗</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="https://bitxiaoxia.github.io" class="site-nav">
            首页
          </a>
        
      
        
          <a href="https://bitxiaoxia.github.io/archives" class="site-nav">
            归档
          </a>
        
      
        
          <a href="https://bitxiaoxia.github.io/tags" class="site-nav">
            标签
          </a>
        
      
        
          <a href="https://bitxiaoxia.github.io/post/about/" class="site-nav">
            关于
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      工作生活中偶有所得，随手记下。
    </div>
    <div class="site-footer">
      转载注明出处</p>
Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://bitxiaoxia.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">关于JAVA多线程执行的问题</h2>
            <div class="post-date">2019-10-10</div>
            
            <div class="post-content">
              <p>最近遇到了一个问题。JAVA进程在Cent OS 7.0 (8核16GB)环境下，使用线程池进行多线程任务。核心线程数从32提升到1024，耗时没有明显提升。<br>
以下是创建线程的代码：</p>
<pre><code>//32线程
ExecutorService executorService = new ThreadPoolExecutor(32, 1024, 8, TimeUnit.SECONDS,new LinkedBlockingDeque&lt;&gt;(), Executors.defaultThreadFactory(), new ThreadPoolExecutor.CallerRunsPolicy());

//1024线程
ExecutorService executorService = new ThreadPoolExecutor(1024, 1024, 8, TimeUnit.SECONDS,new LinkedBlockingQueue&lt;&gt;(), Executors.defaultThreadFactory(), new ThreadPoolExecutor.CallerRunsPolicy());

</code></pre>
<p><strong>32线程</strong><br>
执行572711任务，时间为155min，平均每个线程执行了17000+任务，每个任务耗时约0.5秒<br>
<strong>1024线程</strong><br>
执行547002任务，时间为138min，平均每个线程执行了540个任务，每个任务耗时15.3秒</p>
<blockquote>
<p>附录中摘录了一部分的任务完成时间</p>
</blockquote>
<p><strong>对比，怀疑是由于CPU核数限制了多线程的能力，在线程间的调度花费了太多时间。</strong><br>
但是还有一个问题。<br>
之前测试时1024线程的任务，不使用实际执行，而采用Thread.sleep(10000)，耗时有明显提升，只用了20min完成了96w+任务。</p>
<p>区别在这里</p>
<pre><code>executorService.execute(() -&gt; {
    ...//前置任务
    //try {
    //	Thread.sleep(1000);
    //} catch (Exception e) {
    //	e.printStackTrace();
    //}
	messageService.sendRecallMessage(mpOpenId, lastingDays);
    ...//后置任务
    });
</code></pre>
<p>正常业务使用的<code>sendRecallMessage()</code>方法，是向腾讯发起一个HTTP请求。按照之前的预估，1s内可以完成。使用<code>Thread.sleep(10000)</code>方法模拟请求，，实际耗时却有很大区别。</p>
<ol>
<li>32线程sendRecallMessage,执行572711任务，时间为155min</li>
<li>1024线程sendRecallMessage,执行547002任务，时间为138min</li>
<li>1024线程Thread.sleep(10000),执行96w+任务，时间为20min</li>
</ol>
<p>这里的问题暂时不太能够想明白，按照我的理解应该是因为在调用HTTP请求时，就算在等待接口返回，仍在占用CPU资源，CPU不会调度到其他线程上执行任务，而Thread.sleep则会完全放开CPU资源，直到sleep时间结束，CPU才会继续执行任务。<br>
我想要提问的是：</p>
<ol>
<li>线程池的核心线程数应该和CPU核数有关，8核的机器，一般开多少线程合适呢？</li>
<li>目前有个需求是需要在30min内完成约500w个任务，是否只能拆机器运行？</li>
<li>如果需要多台机器运行，使用生产者消费者模式可以避免进程间通信，比较简单的实现，是否有更好的方法呢？</li>
</ol>
<h1 id="附录">附录</h1>
<blockquote>
<p>32线程thread30的部分任务完成时间</p>
</blockquote>
<pre><code>20：20分时完成了75个任务
20:20:00,077
20:20:00,596
20:20:01,479
20:20:02,116
20:20:03,194
20:20:03,703
20:20:04,208
20:20:04,748
20:20:06,014
20:20:06,738
20:20:07,668
20:20:08,415
20:20:09,269
20:20:09,916
20:20:10,593
20:20:11,191
20:20:11,749
20:20:12,686
20:20:13,196
20:20:13,936
20:20:15,233
20:20:17,074
20:20:18,439
20:20:19,155
20:20:19,769
20:20:20,147
20:20:21,339
20:20:21,929
20:20:22,377
20:20:23,932
20:20:24,692
20:20:25,172
20:20:26,030
20:20:27,179
20:20:27,632
20:20:28,955
20:20:29,669
20:20:30,082
20:20:30,821
20:20:32,359
20:20:33,208
20:20:33,602
20:20:33,982
20:20:34,406
20:20:35,883
20:20:36,607
20:20:37,409
20:20:37,819
20:20:38,329
20:20:39,345
20:20:41,584
20:20:42,404
20:20:43,286
20:20:44,837
20:20:45,501
20:20:45,941
20:20:46,935
20:20:48,103
20:20:49,280
20:20:49,774
20:20:50,596
20:20:51,970
20:20:52,838
20:20:53,253
20:20:54,122
20:20:54,557
20:20:55,433
20:20:55,810
20:20:56,501
20:20:56,942
20:20:57,783
20:20:58,504
20:20:58,856
20:20:59,413
20:20:59,902
</code></pre>
<blockquote>
<p>1024线程thread222的部分任务完成时间</p>
</blockquote>
<pre><code>20：20-20：30完成了53个任务
20:20:17,201
20:20:22,422
20:20:28,378
20:20:34,550
20:20:34,823
20:20:36,171
20:20:36,951
20:20:38,159
20:20:41,383
20:20:56,342
20:20:58,368
20:21:20,064
20:21:21,893
20:21:27,950
20:21:37,572
20:21:38,873
20:22:04,719
20:22:19,368
20:22:22,729
20:22:23,146
20:22:25,188
20:22:25,372
20:22:34,696
20:22:36,581
20:23:14,513
20:23:16,539
20:23:18,074
20:23:37,161
20:24:30,379
20:24:36,548
20:25:29,713
20:25:35,735
20:25:36,021
20:25:54,083
20:26:15,113
20:26:30,697
20:26:31,010
20:26:49,036
20:26:52,096
20:26:53,033
20:26:55,520
20:26:56,935
20:27:08,147
20:27:12,846
20:27:22,821
20:27:30,179
20:27:35,269
20:27:37,967
20:27:53,244
20:28:02,541
20:28:47,764
20:29:26,154
</code></pre>

            </div>
            
            

            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">

AOS.init();

hljs.initHighlightingOnLoad()

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>




  </body>
</html>
